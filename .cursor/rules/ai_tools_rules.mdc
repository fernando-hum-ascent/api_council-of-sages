---
description:
globs: **/orchestrator/tools/**/*.py
alwaysApply: false
---
#  Reglas para Herramientas (Tools) de Kopi AI Orchestrator

Este documento define los est谩ndares y buenas pr谩cticas para el desarrollo y mantenimiento de herramientas (tools) en el orquestador de Kopi AI. Su prop贸sito es asegurar consistencia, calidad y mantenibilidad del c贸digo.

##  Estructura y Nomenclatura

- **Archivos**:
  - Nombrar archivos con sufijo `_tool.py` (ej: `navigation_tool.py`)
  - Usar snake_case para nombres de archivos
  - Organizar el c贸digo siguiendo la estructura est谩ndar:
    1. Imports
    2. Definici贸n de la clase de entrada (Input)
    3. Funciones auxiliares privadas (si son necesarias)
    4. Funci贸n principal del tool
    5. Definici贸n del tool

- **Funci贸n principal**:
  - Usar nombres descriptivos en snake_case (ej: `create_navigator_widget`)
  - Siempre declarar como `async`
  - Incluir anotaciones de tipo para par谩metros y valor de retorno
  - Tipos de retorno deben ser `str` o `Dict[str, Any]` (o `Union` de ambos)

- **Definici贸n del tool**:
  - Nombres en snake_case (ej: `navigator_tool`)
  - Siempre definir con `StructuredTool.from_function`
  - Registrar en `__init__.py` y en `graph_definition.py` (CONTINUING_TOOLS o TERMINAL_TOOLS)

---

##  Modelo de Entrada (Input)

- **Clase de entrada**:
  - Heredar de `BaseModel` de Pydantic
  - Usar PascalCase para el nombre (ej: `ToolNavigatorInput`)
  - Incluir `state: Annotated[OrchestratorState, InjectedState]` si el tool requiere acceso al estado

- **Validaci贸n de par谩metros**:
  - Definir cada campo con `Field` incluyendo:
    - `description`: Descripci贸n clara del par谩metro
    - `examples`: Ejemplos de valores aceptables
    - Reglas de validaci贸n apropiadas cuando sea necesario
  - Usar tipos espec铆ficos como `NonEmptyStr` en lugar de validadores personalizados

---

## О Implementaci贸n

- **Manejo de errores**:
  - Usar obligatoriamente el decorador `@handle_tool_errors_with_logging()`
  - Manejar casos de borde y validaciones adicionales
  - Devolver mensajes de error significativos

- **Acceso al estado**:
  - Acceder al estado a trav茅s del par谩metro inyectado `state`
  - Usar `state.get("propiedad", valor_por_defecto)` para acceder de forma segura
  - Documentar qu茅 propiedades del estado utiliza el tool

- **Monitoreo**:
  - El uso de etiquetas de monitoreo con `LLMObs.annotate()` es opcional pero recomendado
  - Agregar m茅tricas relevantes para el monitoreo y depuraci贸n cuando sea necesario
  - Considerar agregar m茅tricas de rendimiento para operaciones complejas

- **Documentaci贸n**:
  - Proporcionar descripciones claras y concisas en la definici贸n del tool
  - Incluir docstrings para funciones principales y auxiliares
  - Documentar el prop贸sito, entradas, salidas y consideraciones especiales

---

##  Descripci贸n del Tool

La descripci贸n del tool debe incluir:
1. Qu茅 hace la herramienta
2. Cu谩ndo se debe utilizar
3. Qu茅 entradas espera
4. Qu茅 devuelve como salida
5. Limitaciones o consideraciones especiales

---

##  Tipos de Tools

- **Continuing Tools**: Herramientas que se usan durante la conversaci贸n y devuelven el control al orquestador
  - Ejemplos: `auto_equity_tool`, `documentation_tool`, `kavak_policies_tool`
  - No finalizan el flujo de conversaci贸n
  - Se registran en `CONTINUING_TOOLS` en `graph_definition.py`

- **Terminal Tools**: Herramientas que completan tareas espec铆ficas y finalizan el flujo de conversaci贸n
  - Ejemplos: `navigator_tool`, `sdui_generate_complex_widget_tool`
  - Transicionan al nodo END despu茅s de la ejecuci贸n
  - Se registran en `TERMINAL_TOOLS` en `graph_definition.py`

---

##  Lista de Verificaci贸n

Antes de enviar un Pull Request, verificar:

- [ ] El tool sigue la estructura est谩ndar
- [ ] El nombre del archivo termina con `_tool.py`
- [ ] La clase de entrada hereda de `BaseModel`
- [ ] Todos los campos tienen descripciones y ejemplos apropiados
- [ ] La funci贸n principal usa el decorador `@handle_tool_errors_with_logging()`
- [ ] La funci贸n es `async` y tiene anotaciones de tipo
- [ ] El tool est谩 registrado en `__init__.py`
- [ ] El tool est谩 registrado en `graph_definition.py` en la lista correcta
- [ ] La descripci贸n del tool es completa y clara

---

##  Ejemplos de Buenas Pr谩cticas

```python
# Ejemplo de modelo de entrada bien definido
class AutoEquityInput(BaseModel):
    query: NonEmptyStr = Field(
        description="La pregunta sobre Auto Equity",
        examples=["驴Cu谩l es el proceso para obtener un pr茅stamo con mi auto?"],
    )
    state: Annotated[OrchestratorState, InjectedState]

# Ejemplo de funci贸n de tool bien implementada
@handle_tool_errors_with_logging()
async def request_auto_equity(
    query: str,
    state: OrchestratorState,
) -> str:
    """Procesa una consulta sobre Auto Equity y retorna la respuesta.

    Args:
        query: La pregunta del usuario sobre Auto Equity
        state: El estado del orquestador con el historial de conversaci贸n

    Returns:
        str: La respuesta del servicio de Auto Equity
    """
    # Implementaci贸n...
    return response["content"]

# Ejemplo de definici贸n de tool bien documentada
auto_equity_tool = StructuredTool.from_function(
    name="auto_equity_tool",
    description="""
    Responde consultas sobre c贸mo aprovechar el valor del auto para financiamiento.
    Usa esta herramienta cuando el usuario pregunte sobre pr茅stamos con garant铆a
    de su veh铆culo, opciones de financiamiento usando su auto, o temas relacionados
    con Auto Equity.
    """,
    args_schema=AutoEquityInput,
    coroutine=request_auto_equity,
)
```

---

##  Soluci贸n de Problemas Comunes

| Problema | Soluci贸n |
|----------|----------|
| Tool no aparece en el sistema | Verificar registro en `__init__` y `graph_definition` |
| Errores de validaci贸n de par谩metros | Verificar que los datos coincidan con los requisitos del Field |
| Problemas de acceso al estado | Asegurar que el estado est茅 correctamente inyectado y accedido |
| Tool agota el tiempo de espera | Agregar manejo de timeouts y optimizar rendimiento |
| Datos de monitoreo faltantes | Verificar que LLMObs.annotate se llame correctamente |
| Tool no enruta correctamente | Verificar que el tool est茅 en la lista correcta |
